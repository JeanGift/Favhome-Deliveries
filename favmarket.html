<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FavMarket — Buy & Sell in Juja</title>
<meta name="description" content="FavMarket — Community marketplace in Juja. Sell your products, discover goods, buy safely with FavHome." />
<meta name="theme-color" content="#0b76ef" />
<style>
/* CSS as you provided (all included) */
:root{--accent:#0b76ef;--bg-gradient: linear-gradient(135deg,#0f111a,#1a1c2c);--card-gradient: linear-gradient(145deg,#1f2233,#2a2c44);--muted:#aaa;--white:#fff;--shadow-glow: 0 0 20px rgba(255,255,255,0.05), 0 0 40px rgba(0,200,255,0.1);--action-border-default: #e74c3c;}
*{box-sizing:border-box}body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background: var(--bg-gradient);color: var(--white);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow-x:hidden;}
header{background: linear-gradient(90deg,#16a085,#2980b9);color: var(--white);padding:20px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;border-bottom:4px solid var(--white);box-shadow:0 4px 12px rgba(0,0,0,0.5);position:sticky;top:0;z-index:1000;}
.brand{font-weight:800;font-size:24px;text-shadow:0 0 8px rgba(0,0,0,0.6);}
.slogan{font-size:14px;opacity:.9;font-style:italic;}
main{max-width:1080px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:24px;}
@media(min-width:880px){ main{grid-template-columns:2fr 1fr;} }
.card{background: var(--card-gradient);border-radius:16px;padding:20px;box-shadow: var(--shadow-glow),0 8px 20px rgba(0,0,0,.5);transition: transform .28s, box-shadow .28s, background .5s;position: relative;overflow: hidden;}
.card:hover{ transform: translateY(-4px); box-shadow: 0 12px 28px rgba(0,255,255,0.12), 0 12px 24px rgba(0,0,0,0.6); }
h2{ margin-bottom:12px; font-size:22px; color:#2ecc71; position:relative; }
h2::after{ content:''; position:absolute; left:0; bottom:-4px; width:50px; height:3px; background:#3498db; border-radius:2px; animation: glowLine 1.5s infinite alternate; }
@keyframes glowLine{ 0%{ box-shadow: 0 0 5px #3498db; } 100%{ box-shadow: 0 0 15px #3498db; } }
p, li{ margin:0 0 10px; color: var(--muted); line-height:1.6; }
input, textarea, select{ width:100%; padding:12px; border-radius:10px; border:1px solid #555; margin-bottom:12px; font-size:14px; background:#2b2c3c; color:#fff; transition:all .2s; }
input:focus, textarea:focus, select:focus{ outline:none; border-color: var(--accent); box-shadow: 0 0 8px var(--accent); }
.order-btn, .buy-btn{ background: #e67e22; color: var(--white); padding:12px 16px; border-radius:12px; border:none; font-weight:700; cursor:pointer; transition: all .2s; }
.order-btn:hover, .buy-btn:hover{ background:#f1c40f; box-shadow:0 0 12px #f1c40f; }
.listing{ border-radius:16px; padding:12px; background:#2a2c3f; border:1px solid rgba(255,255,255,0.05); transition: transform .2s, box-shadow .2s; display:flex; flex-direction:column; align-items:center; min-height:220px; }
.listing:hover{ transform: scale(1.02); box-shadow:0 8px 20px rgba(0,255,255,0.08); }
.listing img{ max-width:100%; border-radius:12px; margin-bottom:8px; object-fit:cover; height:120px; width:100%; }
.offline{ display:none; padding:12px; border-radius:10px; background:#ffc; color:#664d03; margin-bottom:12px; animation: pulse 2s infinite alternate; }
@keyframes pulse{ 0%{ transform:scale(1); opacity:.8;} 100%{ transform:scale(1.02); opacity:1;} }
.favmarket-btn { position: fixed; bottom: 24px; right: 24px; width: 80px; height: 80px; background: #ffffff; border: 4px solid var(--action-border-default); border-radius: 50%; color: var(--action-border-default); font-weight:700; font-size:14px; text-align:center; line-height:72px; cursor:pointer; z-index:999; transition: transform .3s, box-shadow .3s, background .3s, border-color 8s linear; box-shadow:0 8px 25px rgba(0,0,0,0.4),0 0 15px rgba(255,0,0,0.12); }
.favmarket-btn:hover{ transform: scale(1.12) rotate(-5deg); box-shadow:0 12px 35px rgba(0,0,0,0.5); }
#sellModal, #buyModal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); color:#fff; overflow-y:auto; padding:24px; z-index:9999; }
#sellModal .card, #buyModal .card{ max-width:720px; margin:auto; position:relative; }
.upload-area{ border:2px dashed rgba(255,255,255,0.06); padding:12px; border-radius:12px; text-align:center; cursor:pointer; margin-bottom:12px; position:relative; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); }
.upload-area.dragover{ border-color: rgba(255,255,255,0.22); box-shadow:0 8px 20px rgba(0,0,0,0.6); }
.preview{ display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; }
.preview-card{ position:relative; border-radius:12px; overflow:hidden; background:#111; padding:6px; }
.preview-card img{ height:140px; display:block; width:auto; max-width:260px; object-fit:cover; border-radius:8px; }
.preview-remove{ position:absolute; top:8px; right:8px; background:#e74c3c; color:#fff; border:none; width:34px; height:34px; border-radius:50%; cursor:pointer; font-weight:700; }
.modal-close{ position:absolute; top:12px; right:18px; background:transparent; color:#fff; border:2px solid rgba(255,255,255,0.12); padding:6px 8px; border-radius:999px; cursor:pointer; }
.bottom-buttons{ display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin:24px 0; }
.bottom-buttons button{ padding:12px 16px; border-radius:50px; background:#1f2233; border:3px solid var(--action-border-default); color:#fff; font-weight:600; cursor:pointer; transition: border-color 8s linear, transform .3s; }
.bottom-buttons button:hover{ transform:scale(1.05); box-shadow:0 8px 20px rgba(0,0,0,0.2); }
#listingsContainer{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:12px; }
.small{ font-size:13px; color:var(--muted); }
@media(max-width:520px){ .favmarket-btn{ width:64px; height:64px; line-height:56px; } .preview-card img{ height:110px; } }
</style>
</head>
<body>

<header>
  <div>
    <div class="brand">FavMarket</div>
    <div class="slogan">Buy &amp; Sell Safely — Juja Marketplace</div>
  </div>
</header>

<main>
  <aside class="card">
    <h2>Discover Items</h2>
    <div style="margin-bottom:12px;">
      <input id="searchInput" placeholder="Search item..." style="width:60%;padding:8px;border-radius:8px;border:1px solid #555;margin-right:4px;">
      <input id="minPrice" type="number" placeholder="Min KSh" style="width:18%;padding:8px;border-radius:8px;border:1px solid #555;margin-right:4px;">
      <input id="maxPrice" type="number" placeholder="Max KSh" style="width:18%;padding:8px;border-radius:8px;border:1px solid #555;">
    </div>
    <div id="listingsContainer"></div>
  </aside>
</main>

<div class="bottom-buttons" aria-hidden="false">
  <button data-filter="Top Picks" style="border-color:#e74c3c;color:#f1c40f;">Top Picks</button>
  <button data-filter="Discounts" style="border-color:#3498db;color:#2ecc71;">Discounts</button>
  <button data-filter="Popular" style="border-color:#9b59b6;color:#f39c12;">Popular</button>
  <button data-filter="New Arrivals" style="border-color:#1abc9c;color:#e67e22;">New Arrivals</button>
  <button data-filter="Recommended" style="border-color:#e67e22;color:#2980b9;">Recommended</button>
  <button data-filter="Trending" style="border-color:#34495e;color:#f1c40f;">Trending</button>
  <button data-filter="Limited Deals" style="border-color:#16a085;color:#e74c3c;">Limited Deals</button>
  <button data-filter="Clearance" style="border-color:#8e44ad;color:#1abc9c;">Clearance</button>
  <button data-filter="Hot Offers" style="border-color:#d35400;color:#3498db;">Hot Offers</button>
  <button data-filter="Featured" style="border-color:#c0392b;color:#f39c12;">Featured</button>
</div>

<a href="/" 
   style="display:block; width:120px; margin:25px auto;
          text-align:center; background:#fff; color:#333;
          padding:10px 14px; border-radius:25px;
          box-shadow:0 2px 6px rgba(0,0,0,0.2);
          text-decoration:none;">
  ← Back
</a>


<footer style="text-align:center;padding:18px;color:#b8c7d6;">FavMarket • Safe & Local Buying & Selling — Juja</footer>
<button class="favmarket-btn" id="openSellBtn" title="Sell">Sell</button>

<!-- Modals (Sell & Buy) placeholders -->
<div id="sellModal"><div class="card"><button class="modal-close" onclick="closeSell()">✕</button><form id="sellForm">
  <input id="sellerName" placeholder="Your Name" required>
  <input id="sellerPhone" placeholder="Phone" required>
  <input id="title" placeholder="Item Title" required>
  <textarea id="description" placeholder="Item Description" required></textarea>
  <input id="price" placeholder="Price (KSh)" type="number" required>
  <div id="uploadArea" class="upload-area">Click or drag to upload image</div>
  <input type="file" id="imageFile" accept="image/*" style="display:none;">
  <div id="preview" class="preview"></div>
  <input id="secretQuestion" placeholder="Secret Question (for deletion)" required>
  <input id="secretAnswer" placeholder="Answer" required>
  <select id="payment">
    <option value="MPESA">MPESA</option>
    <option value="Cash">Cash</option>
  </select>
  <button type="submit" class="order-btn">List Item</button>
</form></div></div>

<div id="buyModal"><div class="card"><button class="modal-close" onclick="closeBuy()">✕</button><div id="buyBody"></div><button id="paidBtn" class="buy-btn">I Paid</button></div></div>

<script>
// JS code you provided goes here (full)
const UPLOAD_ENDPOINT = '/upload_image'; const MARKET_ENDPOINT = '/market'; const COOP_PAYBILL = '400200'; const COOP_ACCOUNT = 'FAVMARKET-PAY'; 
let listings = JSON.parse(localStorage.getItem('favmarket_listings') || '[]'); 
let queuedUploads = JSON.parse(localStorage.getItem('favmarket_upload_queue') || '[]'); 
let currentUploadDataURL = ''; 
let currentServerImageUrl = '';
const sellModal = document.getElementById('sellModal');
const buyModal = document.getElementById('buyModal');
const openSellBtn = document.getElementById('openSellBtn');
const sellForm = document.getElementById('sellForm');
const uploadArea = document.getElementById('uploadArea');
const imageFileInput = document.getElementById('imageFile');
const previewContainer = document.getElementById('preview');
const listingsContainer = document.getElementById('listingsContainer');
const offlineBanner = document.getElementById('offline') || {style:{display:'none'}};
const buyBody = document.getElementById('buyBody');
const paidBtn = document.getElementById('paidBtn');

function showOffline(isOffline){ offlineBanner.style.display = isOffline ? 'block' : 'none'; }
showOffline(!navigator.onLine);
window.addEventListener('online', ()=>{ showOffline(false); processQueuedUploads(); syncOfflineListings(); });
window.addEventListener('offline', ()=> showOffline(true));

function el(tag, attrs={}, inner=''){ const e = document.createElement(tag); Object.entries(attrs).forEach(([k,v])=> e.setAttribute(k,v)); if(inner) e.innerHTML=inner; return e; }

uploadArea.addEventListener('click', ()=> imageFileInput.click());
uploadArea.addEventListener('dragover', e=>{ e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', ()=> uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', e=>{ e.preventDefault(); uploadArea.classList.remove('dragover'); const f=e.dataTransfer.files&&e.dataTransfer.files[0]; if(f) handleFileSelection(f); });
imageFileInput.addEventListener('change', e=>{ const f=e.target.files&&e.target.files[0]; if(f) handleFileSelection(f); });

function handleFileSelection(file){ if(!file.type.startsWith('image/')){ alert('Please select an image file.'); return; } if(file.size>8*1024*1024 && !confirm('File is large. Continue?')) return; const reader=new FileReader(); reader.onload=(ev)=>{ currentUploadDataURL=ev.target.result; currentServerImageUrl=''; renderPreview(); uploadFileToServer(file).then(url=>{ currentServerImageUrl=url||''; renderPreview(); }).catch(()=>{ currentServerImageUrl=''; if(!navigator.onLine) queueUpload(file); }); }; reader.readAsDataURL(file); }

function renderPreview(){ previewContainer.innerHTML=''; if(!currentUploadDataURL&&!currentServerImageUrl) return; const pc=el('div',{class:'preview-card'}); const img=el('img'); img.src=currentUploadDataURL||currentServerImageUrl; pc.appendChild(img); if(currentServerImageUrl){ const badge=el('div',{},'<small style="color:#cbd5e1">Uploaded</small>'); badge.style.position='absolute'; badge.style.left='8px'; badge.style.top='8px'; badge.style.background='rgba(0,0,0,0.4)'; badge.style.padding='4px 8px'; badge.style.borderRadius='8px'; pc.appendChild(badge); } const rem=el('button',{class:'preview-remove',title:'Remove image'},'✕'); rem.onclick=ev=>{ ev.stopPropagation(); removePreview(); }; pc.appendChild(rem); previewContainer.appendChild(pc); }

function removePreview(){ currentUploadDataURL=''; currentServerImageUrl=''; imageFileInput.value=''; previewContainer.innerHTML=''; }

function queueUpload(file){ const reader=new FileReader(); reader.onload=ev=>{ queuedUploads.push({id:Date.now(),filename:file.name,dataURL:ev.target.result}); localStorage.setItem('favmarket_upload_queue',JSON.stringify(queuedUploads)); }; reader.readAsDataURL(file); }

async function processQueuedUploads(){ if(!navigator.onLine||!queuedUploads.length) return; const queue=queuedUploads.slice(); queuedUploads=[]; localStorage.setItem('favmarket_upload_queue',JSON.stringify(queuedUploads)); for(const entry of queue){ try{ const blob=dataURLtoBlob(entry.dataURL); await uploadBlobToServer(blob,entry.filename); }catch(e){ console.warn('Queued upload failed',e); } } }

function dataURLtoBlob(dataurl){ const arr=dataurl.split(','); const mime=arr[0].match(/:(.*?);/)[1]; const bstr=atob(arr[1]); let n=bstr.length; const u8arr=new Uint8Array(n); while(n--){ u8arr[n]=bstr.charCodeAt(n); } return new Blob([u8arr],{type:mime}); }

async function uploadFileToServer(file){ try{ const fd=new FormData(); fd.append('file',file); const res=await fetch(UPLOAD_ENDPOINT,{method:'POST',body:fd}); if(!res.ok) throw new Error('Upload failed'); const j=await res.json(); return j && j.ok && j.url ? j.url : null; }catch(err){ throw err; } }

async function uploadBlobToServer(blob,filename){ try{ const fd=new FormData(); fd.append('file',blob,filename||('img-'+Date.now()+'.png')); const res=await fetch(UPLOAD_ENDPOINT,{method:'POST',body:fd}); if(!res.ok) throw new Error('Upload failed'); const j=await res.json(); return (j && j.ok)?j.url:null; }catch(e){ throw e; } }

function saveListings(){ localStorage.setItem('favmarket_listings',JSON.stringify(listings)); }

function renderListings(){ listingsContainer.innerHTML=''; const q=(document.getElementById('searchInput')||{value:''}).value.trim().toLowerCase(); const minP=parseFloat((document.getElementById('minPrice')||{value:''}).value)||0; const maxP=parseFloat((document.getElementById('maxPrice')||{value:''}).value)||Infinity; let filtered=listings.filter(item=>{ const price=parseFloat(item.price)||0; const matchesText=!q||(item.title&&item.title.toLowerCase().includes(q))||(item.description&&item.description.toLowerCase().includes(q)); return matchesText&&price>=minP&&price<=maxP; }); if(!filtered.length){ listingsContainer.innerHTML='<p class="small">No items found.</p>'; return; } filtered.forEach((item,idx)=>{ const d=el('div',{class:'listing'}); d.innerHTML=`${item.image?`<img src="${item.image}" alt="${item.title}">`:''}<h3>${item.title}</h3><p><strong>KSh ${item.price}</strong></p><p class="small">Seller: ${item.sellerName}</p>`; const btnRow=el('div',{},''); btnRow.style.display='flex'; btnRow.style.gap='6px'; btnRow.style.width='100%'; const buy=el('button',{class:'buy-btn'},'Buy'); buy.style.flex='1'; buy.onclick=ev=>{ ev.stopPropagation(); openBuyModal(idx); }; const del=el('button',{class:'order-btn'},'Delete'); del.style.flex='1'; del.style.background='#c0392b'; del.onclick=ev=>{ ev.stopPropagation(); attemptDelete(idx); }; btnRow.appendChild(buy); btnRow.appendChild(del); d.appendChild(btnRow); d.onclick=()=> openFullView(item,idx); listingsContainer.appendChild(d); }); }

function escapeHTML(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function openFullView(item,idx){ const overlay=el('div',{style:'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.96);color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:28px;z-index:99999;overflow-y:auto;'}); overlay.innerHTML=`${item.image?`<img src="${item.image}" style="max-width:980px;width:95%;border-radius:12px;margin-bottom:14px;">`:''}<h2>${item.title}</h2><p>${item.description}</p><p><strong>KSh ${item.price}</strong></p><p class="small">Seller: ${item.sellerName} | ${item.phone}</p><div style="display:flex;gap:10px;"><button id="ovBuy" class="order-btn">Buy</button><button id="ovClose" class="buy-btn" style="background:#c0392b">Close</button></div>`; document.body.appendChild(overlay); document.getElementById('ovBuy').onclick=()=>openBuyModalIndex(idx); document.getElementById('ovClose').onclick=()=>document.body.removeChild(overlay); let startY=0; overlay.addEventListener('touchstart',e=>{ startY=e.touches[0].clientY; }); overlay.addEventListener('touchmove',e=>{ const dy=e.touches[0].clientY-startY; if(dy>150) document.body.removeChild(overlay); }); }

function openBuyModal(idx){ openBuyModalIndex(idx); }
function openBuyModalIndex(idx){ const item=listings[idx]; buyModal.style.display='block'; buyModal.setAttribute('aria-hidden','false'); buyBody.innerHTML=`<div style="text-align:center;">${item.image?`<img src="${item.image}" style="max-width:320px;border-radius:10px;margin-bottom:12px;">`:''}<h3>${item.title}</h3><p class="small">${item.description}</p><p><strong>KSh ${item.price}</strong></p><p>Paybill: <strong>${COOP_PAYBILL}</strong></p><p>Account: <strong>${COOP_ACCOUNT}</strong></p><p class="small">Please pay the exact amount on your MPESA app or via USSD.</p></div>`; paidBtn.onclick=()=>{ alert('Thank you.'); markSoldByIndex(idx); closeBuy(); }; }

function closeBuy(){ buyModal.style.display='none'; buyModal.setAttribute('aria-hidden','true'); }
function markSoldByIndex(idx){ const it=listings[idx]; if(!it) return; it.sold=true; saveListings(); renderListings(); }

function attemptDelete(idx){ const it=listings[idx]; if(!it) return; if(!it.secretQuestion||!it.secretAnswer){ if(confirm('Are you sure you want to delete this item?')){ listings.splice(idx,1); saveListings(); renderListings(); } return; } const ans=prompt(it.secretQuestion); if(ans && ans.trim().toLowerCase()===it.secretAnswer.toLowerCase()){ listings.splice(idx,1); saveListings(); renderListings(); alert('Item deleted'); } else alert('Incorrect answer. Cannot delete item.'); }

sellForm.addEventListener('submit', async e=>{ e.preventDefault(); const sellerName=document.getElementById('sellerName').value.trim(); const sellerPhone=document.getElementById('sellerPhone').value.trim(); const title=document.getElementById('title').value.trim(); const description=document.getElementById('description').value.trim(); const price=document.getElementById('price').value.trim(); const payment=document.getElementById('payment').value; const secretQuestion=document.getElementById('secretQuestion').value.trim(); const secretAnswer=document.getElementById('secretAnswer').value.trim(); if(!sellerName||!sellerPhone||!title||!description||!price||!secretQuestion||!secretAnswer){ alert('Please fill all required fields.'); return; } let imageUrl=currentServerImageUrl||''; if(!imageUrl&&currentUploadDataURL){ if(navigator.onLine){ try{ imageUrl=await uploadBlobToServer(dataURLtoBlob(currentUploadDataURL),`listing-${Date.now()}.png`); }catch(e){ console.warn('upload failed',e); } } if(!imageUrl) imageUrl=currentUploadDataURL; } const listing={id:Date.now(),sellerName,phone:sellerPhone,title,description,price,payment,image:imageUrl,secretQuestion,secretAnswer:secretAnswer.toLowerCase(),created_at:new Date().toISOString(),sold:false}; listings.unshift(listing); saveListings(); renderListings(); sellForm.reset(); removePreview(); currentServerImageUrl=''; document.getElementById('sellModal').style.display='none'; alert('Item listed successfully!'); });

document.querySelectorAll('.bottom-buttons button').forEach(btn=>{ btn.addEventListener('click',()=>renderListings()); });
document.getElementById('searchInput').addEventListener('input',()=>renderListings());
document.getElementById('minPrice').addEventListener('input',()=>renderListings());
document.getElementById('maxPrice').addEventListener('input',()=>renderListings());

openSellBtn.addEventListener('click',()=>{ sellModal.style.display='block'; sellModal.setAttribute('aria-hidden','false'); });
function closeSell(){ sellModal.style.display='none'; sellModal.setAttribute('aria-hidden','true'); }

renderListings();
processQueuedUploads();
</script>

</body>
</html>

